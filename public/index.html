<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<title>ü§ñ Train the Robot ‚Äì Coop Edition</title>
<script src="/socket.io/socket.io.js"></script>
<style>
  body { font-family: "Poppins", sans-serif; background: #f7f9fb; text-align:center; margin:0; }
  header { background:#0066cc; color:white; padding:1.2em; font-size:1.4em; box-shadow:0 2px 10px rgba(0,0,0,0.1);}
  #container { max-width:900px; margin:2em auto; padding:1em; display:flex; flex-direction:column; align-items:center; }
  .grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(350px,1fr)); gap:1.5em; width:100%; }
  .card { background:white; border-radius:12px; padding:1.5em; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
  button { padding:.8em 1.4em; margin:.3em; border-radius:8px; border:none; cursor:pointer; font-size:1em; transition:0.2s;}
  .yes{background:#4caf50;color:white;} .no{background:#f44336;color:white;} .neutral{background:#ff9800;color:white;}
  input,select{padding:.4em .6em;font-size:1em;border-radius:6px;border:1px solid #ccc;margin:.3em;}
  #robot{font-size:4em;margin:.3em 0;}
  #status{margin-bottom:1em;}
  #metrics{font-size:1.1em; margin-top:.5em;}
</style>
</head>
<body>
  <header>ü§ñ Train the Robot ‚Äì Coop Edition</header>

  <div id="container">

    <div id="login" class="card" style="max-width:400px;">
      <h3>Benvenuto!</h3>
      <p>Inserisci il tuo nome per iniziare:</p>
      <input type="text" id="username" placeholder="Il tuo nome" />
      <br><br>
      <button onclick="joinGame()">Entra nel gioco üöÄ</button>
    </div>

    <div id="game" style="display:none;width:100%;">
      <div id="robot">üòê</div>
      <h3 id="status">Connessione...</h3>
      <button id="resetBtn" class="neutral" onclick="resetBot()" style="display:none;">üîÑ Reset Robot</button>

      <div class="grid">
        <div id="train" class="card">
          <h3>üß© Addestra il robot</h3>
          <p id="profileDesc"></p>
          <button class="yes" onclick="sendExample(true)">‚úÖ Ha bisogno di aiuto</button>
          <button class="no" onclick="sendExample(false)">‚ùå Non ha bisogno</button>
          <p id="progressText">Esempi raccolti: 0</p>
          <p id="metrics">Accuratezza: 0.00 | Fairness gap: 0.00</p>
        </div>

        <div id="predict" class="card">
          <h3>ü§î Chiedi al robot</h3>
          <p>Inserisci un caso e scopri cosa farebbe il robot:</p>
          Et√†: <input type="number" id="eta" min="18" max="90" value="40"><br>
          Reddito: <input type="number" id="reddito" min="200" max="4000" value="1200"><br>
          Disabilit√†:
          <select id="disabilita">
            <option value="false">No</option>
            <option value="true">S√¨</option>
          </select><br><br>
          <button onclick="askPrediction()">üîç Interroga il robot</button>
          <p id="predResult"></p>
        </div>
      </div>
    </div>
  </div>

<script>
  const socket = io();
  const profiles = [
    {eta:70,reddito:800,disabilita:true},
    {eta:28,reddito:3000,disabilita:false},
    {eta:45,reddito:1200,disabilita:false},
    {eta:60,reddito:1000,disabilita:true},
    {eta:35,reddito:2200,disabilita:false},
    {eta:50,reddito:700,disabilita:false}
  ];

  let current = {}, username="", total=0;

  function joinGame(){
    username=document.getElementById("username").value.trim();
    if(!username){alert("Inserisci un nome per giocare!");return;}
    document.getElementById("login").style.display="none";
    document.getElementById("game").style.display="block";
    socket.emit("setName",username);
  }

  socket.on("connect",()=>{
    setRobotFace("üôÇ");
    document.getElementById("status").textContent="Connesso ‚úÖ";
    nextProfile();
  });

  socket.on("userJoined",(d)=>{
    document.getElementById("status").textContent=`${d.name} si √® unito! (${d.totalPlayers} giocatori attivi)`;
  });

  socket.on("datasetUpdate",(d)=>{
    total = d.size;
    const acc = d.accuracy ? d.accuracy.toFixed(2) : "0.00";
    const fair = d.fairness ? d.fairness.toFixed(2) : "0.00";
    document.getElementById("progressText").textContent=`Esempi raccolti: ${total}`;
    document.getElementById("metrics").innerHTML = `Accuratezza: <b>${acc}</b> | Fairness gap: <b style="color:${fair>0.2?'red':'green'}">${fair}</b>`;
    document.getElementById("resetBtn").style.display="inline-block";
  });

  socket.on("predictionResult",(data)=>{
    if(data.error){alert(data.error);return;}
    const res=data.prediction?"‚úÖ Il robot aiuterebbe":"‚ùå Il robot NON aiuterebbe";
    document.getElementById("predResult").innerHTML=`Et√† ${data.eta}, Reddito ${data.reddito}‚Ç¨, Disabilit√† ${data.disabilita?"S√¨":"No"} ‚Üí <b>${res}</b>`;
    setRobotFace(data.prediction?"üòÑ":"üôÉ");
  });

  socket.on("resetDone",(msg)=>{
    document.getElementById("status").textContent=msg.message;
    setRobotFace("üòê");
    total=0;
    document.getElementById("progressText").textContent="Esempi raccolti: 0";
    document.getElementById("metrics").textContent="Accuratezza: 0.00 | Fairness gap: 0.00";
    nextProfile();
  });

  function nextProfile(){
    current=profiles[Math.floor(Math.random()*profiles.length)];
    document.getElementById("profileDesc").textContent=
      `Et√†: ${current.eta}, Reddito: ${current.reddito}‚Ç¨, Disabilit√†: ${current.disabilita?"S√¨":"No"}`;
  }

  function sendExample(label){
    socket.emit("trainExample",{...current,label});
    nextProfile();
  }

  function askPrediction(){
    const eta=parseInt(document.getElementById("eta").value);
    const reddito=parseInt(document.getElementById("reddito").value);
    const disabilita=document.getElementById("disabilita").value==="true";
    socket.emit("predict",{eta,reddito,disabilita});
  }

  function resetBot(){
    if(confirm("Vuoi davvero resettare il robot per tutti i giocatori?"))
      socket.emit("resetModel");
  }

  function setRobotFace(f){
    document.getElementById("robot").textContent=f;
  }
</script>
</body>
</html>
